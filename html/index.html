<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
		<title>test_websocket</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<style>
		.pageHalf {
			display: inline-block;
			vertical-align: top;
		}
		.error {
			color: red;
		}
		#output {
			width: 400px;
		}
		</style>
        <script type="text/javascript">
			var websocket
			function writeLog(msg) {
				var now = new Date()
				$('#log').append(now + ' ' + msg + '<br>')
			}
			function writeErr(msg) {
				writeLog('<span class="error">' + msg + '</span>')
			}
			function ab2str(buf) {
				var s = ""
				var b = new Uint8Array(buf);
				for (var i=0; i<b.length; ++i) s += Number(b[i]) + " "
				return s
			}
			function connect() {
                window.WebSocket = window.WebSocket || window.MozWebSocket;

                websocket = new WebSocket('ws://127.0.0.1:10002', 'binary')
				websocket.binaryType = "arraybuffer"
				if (!websocket) {
					writeErr('Error creating web socket.') 
				} else {
					writeLog('Connecting...')
				}

                websocket.onopen = function () {
					writeLog('Connected')
                };

                websocket.onerror = function (e) {
					writeErr('Error occured. Reconnecting...')
//					setTimeout(connect, 1000);
                };

                websocket.onmessage = function (message) {
                    console.log(message);
                    console.log(new Uint8Array(message.data));
//                    $('#log').append($('<p>', { text: ab2str(message.data) }));
                    writeLog('Recv buffer ' + ab2str(message.data));
                };

				websocket.onclose = function () {
					writeLog('Disconnected')
				};
                
			}
			function initHandlers() {
                $('button').click(function(e) {
//                    websocket.send($('#input').val());
					var kernel = {
						_type: {
							id: 2
						},
						_result: 1,
						_id: 1,
						_parent: 0,
						_principal: 0,
						data: 123
					};
					var kernelSize = 24
					var numKernels = 6
					var buf = new ArrayBuffer(kernelSize * numKernels)
					var view = new DataView(buf);
					for (var i=0; i<numKernels; ++i) {
						var offset = kernelSize * i
						view.setUint32(offset + 0, kernelSize)
						view.setUint16(offset + 4, kernel._type.id)
						view.setUint16(offset + 6, kernel._result)
						view.setUint32(offset + 8, kernel._id)
						view.setUint32(offset + 12, kernel._parent)
						view.setUint32(offset + 14, kernel._principal)
						view.setUint32(offset + 20, kernel.data)
					}
					writeLog('Sending buffer ('
						+ buf.byteLength + ') ' + ab2str(buf))
                    websocket.send(buf);
                });
			}
			function initAll() {
				initHandlers()
				connect()
			}
            $(document).ready(initAll);
        </script>
    </head>
    <body>
        <h1>test_websocket</h1>
        <div id="log">
			<h3>Log</h3>
	        <button>Send</button><br>
		</div>
    </body>
</html>
