#!/bin/sh

usage() {
	echo "USAGE: $(basename $0) [--kill IP-address] [--after time-in-seconds] [--size problem-size]"
	exit 1
}

size=3000
master="10.0.0.1"
prefix="slave"

while test -n "$1"; do
	case "$1" in
		--master)
			shift
			master=$1
			;;
		--kill)
			shift
			kill=$1
			;;
		--after)
			shift
			after=$1
			;;
		--size)
			shift
			after=$1
			;;
		--prefix)
			shift
			prefix=$1
			;;
		*)
			echo "Unknown option '$1'"
			usage
			;;
	esac
	shift
done

args=
if test -n "$kill"; then
	args="$args --kill $kill"
fi
if test -n "$after"; then
	args="$args --kill-after $after"
fi


echo "----------------------------------------"
if test -z "$kill"; then
	echo "Mode: no faults"
elif test "$master" = "$kill"; then
	echo "Mode: master fault"
else
	echo "Mode: slave fault"
fi
echo "Prefix: $prefix"
echo "Master node: $master"
echo "Failing node: $kill"
echo "Time until failure: $after"
echo "----------------------------------------"

cat >autoreg.model << EOF
linear=1
skewness=0.25
kurtosis=0.4
size_factor=1.4
zsize=$size 32 32
zdelta=1 1 1
acf_size=10 10 10
EOF
for i in $(seq 1 12); do
	./$prefix-failure-test --num-hosts $i --network 10.0.0.1/24 --master $master --timeout 60 $args
	t=$(cat time.log)
	echo "$i,$t,$size,$prefix,$master,$kill,$after" >> time.csv
	sleep 10
done 2>&1 | tee benchmark-$(date +%F_%T).log
#--kill 10.0.0.2
#--kill-after 8
