#!/bin/sh

# Benchmark application performance in the presence
# of failure of all nodes except one. 

set -e

ADDR_PREFIX=10.0
cluster=physical
profile=failures
PREFIX=$(pwd)
while [ -n "$1" ]
do
	case "$1" in
		--virtual)
			cluster=virtual
			shift
			;;
		--physical)
			cluster=physical
			shift
			;;
		--failures)
			profile=failures
			shift
			;;
		--no-failures)
			profile=no-failures
			shift
			;;
		--prefix)
			shift
			PREFIX="$1"
			shift
			;;
	esac
done

EXECUTABLE="$PREFIX/build/src/apps/discovery/node-failure-test"
CLUSTER="$PREFIX/scripts/cluster"
WORKDIR=$HOME/arma-test/run-4

if ! test -x "$EXECUTABLE"
then
	echo "Unable to find executable: $EXECUTABLE"
	exit 1
fi	
if ! test -x "$CLUSTER"
then
	echo "Unable to find virtual cluster script: $CLUSTER"
	exit 2
fi	
mkdir -p $WORKDIR
export UNISTDX_CONCURRENCY=1
cp $PREFIX/build/autoreg.model $WORKDIR/
cp $PREFIX/build/MersenneTwister.dat $WORKDIR/
cd $WORKDIR/

intersperse() { local IFS="$1"; shift; echo "$*"; }
fmt="${ADDR_PREFIX}.0.%.f" 

if test "$profile" = "failures"
then
	for num_nodes in $(seq 12 12)
	do
		echo "No. of nodes = $num_nodes"
		for i in $(seq $num_nodes)
		do
			survivor="${ADDR_PREFIX}.0.${i}"
			# kill every node except the survivor
			victims=$(intersperse , $(
			for a in $(seq -f "$fmt" $num_nodes)
			do
				test "$a" = "$survivor" || echo "$a"
			done))
	
			if test "$cluster" = "virtual"
			then
				cmd_prefix="unshare -rnm $CLUSTER --name cat --nodes 1-$num_nodes --"
			else
				cmd_prefix=
			fi
			echo $survivor
			echo $victims
			$cmd_prefix \
			$EXECUTABLE \
				--role master \
				--num-hosts $num_nodes \
				--network ${ADDR_PREFIX}.0.1/24 \
				--test-duration 300 \
				--kill-after 1 \
				--victims $victims \
				--ssh 1 \
				2>&1 | tee benchmark-node-failure-$(printf "%02.f" $i)-${survivor}.log
		done
	done
else
	for num_nodes in $(seq 1 12)
	do
		echo "No. of nodes = $num_nodes"
		if test "$cluster" = "virtual"
		then
			cmd_prefix="unshare -rnm $CLUSTER --name cat --nodes 1-$num_nodes --"
		else
			cmd_prefix=
		fi
		$cmd_prefix \
		$EXECUTABLE \
			--role master \
			--num-hosts $num_nodes \
			--network ${ADDR_PREFIX}.0.1/24 \
			--test-duration 300 \
			--kill-after 1 \
			--ssh 1 \
			2>&1 | tee benchmark-no-failure-$(printf "%04.f" $num_nodes).log
	done
fi
