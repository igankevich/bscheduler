#!/bin/sh

# Benchmark application performance in the presence
# of failure of all nodes except one. 

set -e

ADDR_PREFIX=10.0
cluster=physical
profile=failures
nprocs=12
PREFIX=$(pwd)
while [ -n "$1" ]
do
	case "$1" in
		--virtual)
			cluster=virtual
			shift
			;;
		--physical)
			cluster=physical
			shift
			;;
		--failures)
			profile=failures
			shift
			;;
		--no-failures)
			profile=no-failures
			shift
			;;
		--nprocs|-n|-np)
			shift
			nprocs="$1"
			shift
			;;
		--prefix)
			shift
			PREFIX="$1"
			shift
			;;
	esac
done

if test -z "$RUN_ID"
then
	echo "Please, specify run id via RUN_ID"
	exit 10
fi

EXECUTABLE="$PREFIX/build/src/apps/discovery/node-failure-test"
CLUSTER="$PREFIX/scripts/cluster"
WORKDIR=$HOME/arma-test/run-${RUN_ID}

if ! test -x "$EXECUTABLE"
then
	echo "Unable to find executable: $EXECUTABLE"
	exit 1
fi	
if ! test -x "$CLUSTER"
then
	echo "Unable to find virtual cluster script: $CLUSTER"
	exit 2
fi	
mkdir -p $WORKDIR
export UNISTDX_CONCURRENCY=1
cp $PREFIX/build/autoreg.model $WORKDIR/
cp $PREFIX/build/MersenneTwister.dat $WORKDIR/
cd $WORKDIR/

intersperse() { local IFS="$1"; shift; echo "$*"; }
fmt="${ADDR_PREFIX}.0.%.f" 

if test "$profile" = "failures"
then
	num_nodes=$nprocs
	echo "No. of nodes = $num_nodes"
	for i in $(seq $num_nodes)
	do
		survivor="${ADDR_PREFIX}.0.${i}"
		# kill every node except the survivor
		victims=$(intersperse , $(
		for a in $(seq -f "$fmt" $num_nodes)
		do
			test "$a" = "$survivor" || echo "$a"
		done))
	
		if test "$cluster" = "virtual"
		then
			cluster_name="cat"
			cmd_prefix="unshare -rnm $CLUSTER --name $cluster_name --nodes 1-$num_nodes --"
			more_options="--cluster $cluster_name --netns 1"
		else
			cmd_prefix=
			more_options="--ssh 1"
		fi
		echo $survivor
		echo $victims
		$cmd_prefix \
		$EXECUTABLE \
			--role master \
			--num-hosts $num_nodes \
			--network ${ADDR_PREFIX}.0.1/24 \
			--test-duration 120 \
			--kill-after 1 \
			--victims $victims \
			$more_options \
			2>&1 | tee benchmark-node-failure-$(printf "%02.f" $i)-${survivor}.log
	done
else
	num_nodes=$nprocs
	echo "No. of nodes = $num_nodes"
	if test "$cluster" = "virtual"
	then
		cluster_name="cat"
		cmd_prefix="unshare -rnm $CLUSTER --name $cluster_name --nodes 1-$num_nodes --"
		more_options="--cluster $cluster_name --netns 1"
	else
		cmd_prefix=
		more_options="--ssh 1"
	fi
	$cmd_prefix \
	$EXECUTABLE \
		--role master \
		--num-hosts $num_nodes \
		--network ${ADDR_PREFIX}.0.1/24 \
		--test-duration 120 \
		--kill-after 1 \
		$more_options \
		2>&1 | tee benchmark-no-failure-$(printf "%04.f" $num_nodes).log
fi
