#!/bin/sh

nodes=1
vnodes=100
vnodes_per_node=$(expr $vnodes / $nodes)
export START_TIME=$(expr $(date +%s%N) \+ 30000000000)

echo "Start time: $START_TIME"

#seq -f "m%.f" 2 11 |
{
cat << EOF
m3
m4
m6
m8
m9
m10
m11
EOF
} |
{
for start in $(seq 1 $vnodes_per_node $vnodes); do
	end=$(expr $start \+ $vnodes_per_node - 1)
	read node
	echo "$node: $start-$end" 1>&2
	ssh $node START_TIME=$START_TIME /mnt/images/bin/cluster \
		--cluster cat --bridge br0 \
		--nodes $start-$end -- \
		/mnt/images/bin/test_discovery --num-peers $vnodes --base-ip 10.0.0.1 \
		& \
done | grep -h ' grph ' | sort -nk1 -t' '
wait
}


#		 ping -c 2 10.0.0.3 \
#		hostname \
