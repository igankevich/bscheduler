#include <cmath>
#include <valarray>
#include <iostream>

#include <autoreg/ssysv.hh>
#include <autoreg/vector_n.hh>

namespace  {
    const AUTOREG_REAL_TYPE coefs[] {
        0.943522,
            -0.00455612,
            -0.0027976,
            -0.0018318,
            -0.00129769,
            -0.000987686,
            -0.000788889,
            -0.00064405,
            -0.00126432,
            0.0774356,
            -0.0646328,
            -0.00267093,
            -0.00160758,
            -0.00104855,
            -0.000753974,
            -0.000588861,
            -0.000482524,
            -0.000401451,
            -9.60257e-05,
            -0.00846058,
            0.00679431,
            0.000347024,
            0.000161629,
            4.35842e-05,
            -2.4404e-05,
            -5.74016e-05,
            -6.79044e-05,
            -6.56149e-05,
            0.000660288,
            -0.0710036,
            0.0616053,
            0.00253704,
            0.00134193,
            0.000709919,
            0.000393407,
            0.000244149,
            0.000177357,
            0.000147291,
            0.0011052,
            -0.0811801,
            0.0722128,
            0.0028126,
            0.00140711,
            0.00069573,
            0.000363075,
            0.000223376,
            0.000173324,
            0.000159646,
            0.00154032,
            -0.0445728,
            0.0406663,
            0.00142931,
            0.00064224,
            0.000267795,
            0.000111222,
            6.00746e-05,
            5.40278e-05,
            6.39098e-05,
            0.00186673,
            0.00911345,
            -0.00784718,
            -0.00045916,
            -0.000248058,
            -0.000115365,
            -3.71714e-05,
            4.8788e-06,
            2.47336e-05,
            3.26715e-05,
            0.00168034,
            0.0470846,
            -0.0432382,
            -0.00167183,
            -0.000692909,
            -0.00018407,
            5.57073e-05,
            0.000150066,
            0.00017172,
            0.000161096,
            0.0009472,
            0.0516272,
            -0.048168,
            -0.00167419,
            -0.000563848,
            7.24709e-07,
            0.000258946,
            0.000355944,
            0.000374868,
            0.000359973,
            0.000494392,
            0.0265019,
            -0.02539,
            -0.000718534,
            -0.000110281,
            0.000193744,
            0.000332195,
            0.000387502,
            0.000405164,
            0.000407757,
            0.003214,
            0.0663187,
            -0.0509906,
            -0.0025694,
            -0.00157253,
            -0.00103025,
            -0.000753298,
            -0.000617283,
            -0.000545962,
            -0.000496701,
            -0.00113123,
            0.0359349,
            -0.0286338,
            -0.00144289,
            -0.000846869,
            -0.000546718,
            -0.000414421,
            -0.000365487,
            -0.000348612,
            -0.000336069,
            -0.000264212,
            -0.00527545,
            0.00421632,
            0.000240607,
            0.000126138,
            4.07227e-05,
            -1.95227e-05,
            -5.80869e-05,
            -7.87129e-05,
            -8.54109e-05,
            0.000515544,
            -0.0321276,
            0.0271856,
            0.00140047,
            0.000707744,
            0.00033265,
            0.000153011,
            8.47589e-05,
            7.31448e-05,
            8.48008e-05,
            0.00118872,
            -0.0341951,
            0.0300002,
            0.00149391,
            0.000673751,
            0.000255326,
            8.05975e-05,
            3.99519e-05,
            6.22456e-05,
            0.000104935,
            0.00175118,
            -0.0171609,
            0.0157086,
            0.000714416,
            0.000246443,
            2.60549e-05,
            -4.62328e-05,
            -4.00643e-05,
            -5.27006e-07,
            4.59463e-05,
            0.00195747,
            0.00473715,
            -0.00406731,
            -0.000296319,
            -0.000176866,
            -9.05706e-05,
            -3.03261e-05,
            9.36091e-06,
            3.31805e-05,
            4.53487e-05,
            0.00156576,
            0.0185356,
            -0.0173573,
            -0.000922624,
            -0.000333474,
            -7.38707e-06,
            0.000148347,
            0.000201173,
            0.000197535,
            0.000167543,
            0.000789555,
            0.0188626,
            -0.0183111,
            -0.000902715,
            -0.00021598,
            0.00015676,
            0.000326987,
            0.000376775,
            0.000362709,
            0.000321038,
            0.000369121,
            0.00861122,
            -0.00893083,
            -0.00036921,
            2.29454e-05,
            0.000233478,
            0.0003279,
            0.000355063,
            0.000348673,
            0.000329993,
            0.00295864,
            -0.0113375,
            0.0103528,
            0.000112424,
            0.000107857,
            0.000105389,
            8.32166e-05,
            4.26219e-05,
            -6.66105e-06,
            -5.41306e-05,
            -0.00011383,
            -0.00725343,
            0.00674079,
            6.55412e-05,
            7.85065e-05,
            8.10791e-05,
            6.0928e-05,
            2.24891e-05,
            -2.40802e-05,
            -6.87468e-05,
            -9.3511e-05,
            0.000585108,
            -0.000516089,
            -4.02105e-06,
            1.25425e-05,
            1.22874e-05,
            1.35128e-06,
            -1.45589e-05,
            -3.08548e-05,
            -4.43431e-05,
            0.000205183,
            0.00709733,
            -0.00672509,
            -4.75493e-05,
            -4.93526e-05,
            -6.41182e-05,
            -6.88429e-05,
            -5.85936e-05,
            -3.66095e-05,
            -8.71178e-06,
            0.000769569,
            0.00864919,
            -0.00832906,
            -4.95941e-05,
            -7.84816e-05,
            -0.000108959,
            -0.000113476,
            -8.95382e-05,
            -4.55403e-05,
            7.29661e-06,
            0.00130847,
            0.00503756,
            -0.0049402,
            -2.52004e-05,
            -6.52792e-05,
            -9.51009e-05,
            -9.87735e-05,
            -7.73639e-05,
            -3.90851e-05,
            6.35549e-06,
            0.00141939,
            -0.000884042,
            0.000822515,
            4.15469e-06,
            -1.63137e-05,
            -2.03675e-05,
            -1.39411e-05,
            -1.93437e-06,
            1.18543e-05,
            2.47281e-05,
            0.00092606,
            -0.00535408,
            0.00529881,
            2.69037e-05,
            4.7859e-05,
            8.36885e-05,
            0.000109255,
            0.000117049,
            0.000108434,
            8.83666e-05,
            0.000132295,
            -0.00605655,
            0.00610588,
            3.81993e-05,
            9.43346e-05,
            0.000157882,
            0.000198844,
            0.000210115,
            0.000195959,
            0.000164977,
            -0.000240897,
            -0.00323882,
            0.00335445,
            2.98604e-05,
            8.80527e-05,
            0.000143499,
            0.000178765,
            0.000190962,
            0.000184365,
            0.000165845,
            0.0012448,
            -0.0590788,
            0.0453294,
            0.00198224,
            0.00127043,
            0.000868022,
            0.000637988,
            0.000498761,
            0.000404595,
            0.00033191,
            0.00127014,
            -0.0311563,
            0.0249427,
            0.00104419,
            0.000646472,
            0.000435859,
            0.000323568,
            0.00025794,
            0.000211354,
            0.000170974,
            0.00042112,
            0.0050358,
            -0.00404228,
            -0.000230159,
            -0.00011968,
            -4.68742e-05,
            -2.80757e-06,
            1.99463e-05,
            2.76425e-05,
            2.54997e-05,
            5.20096e-06,
            0.027405,
            -0.0237315,
            -0.0010506,
            -0.000552978,
            -0.00028051,
            -0.000138573,
            -6.82584e-05,
            -3.44682e-05,
            -1.74848e-05,
            0.000201578,
            0.0280793,
            -0.0256816,
            -0.00108025,
            -0.000523228,
            -0.000234095,
            -9.44299e-05,
            -3.15231e-05,
            -3.32307e-06,
            1.24389e-05,
            0.000620982,
            0.0133153,
            -0.0131076,
            -0.000496845,
            -0.000204215,
            -6.46327e-05,
            -6.06011e-06,
            1.50733e-05,
            2.30971e-05,
            2.99059e-05,
            0.000722307,
            -0.00425363,
            0.00374624,
            0.000254413,
            0.000144878,
            7.27747e-05,
            2.82488e-05,
            3.80691e-06,
            -6.40377e-06,
            -7.02603e-06,
            0.000214995,
            -0.0143486,
            0.0147905,
            0.00076201,
            0.000356433,
            0.000135522,
            2.39861e-05,
            -2.65578e-05,
            -4.58926e-05,
            -5.13243e-05,
            -0.000656354,
            -0.0137038,
            0.0153534,
            0.00081237,
            0.000374875,
            0.000146193,
            3.74315e-05,
            -8.1545e-06,
            -2.48473e-05,
            -3.17632e-05,
            -0.000963417,
            -0.00554833,
            0.00731051,
            0.000403956,
            0.000184709,
            7.90466e-05,
            3.5724e-05,
            2.22416e-05,
            1.93726e-05,
            1.69371e-05,
            -0.000458144,
            -0.0630347,
            0.0461642,
            0.00237273,
            0.00150609,
            0.000980378,
            0.000675378,
            0.00050672,
            0.000417152,
            0.000369422,
            0.00202915,
            -0.0314585,
            0.0240417,
            0.00122741,
            0.00072707,
            0.000437591,
            0.000283386,
            0.000210655,
            0.000182605,
            0.000175318,
            0.000860657,
            0.00576757,
            -0.004534,
            -0.000298868,
            -0.000185112,
            -0.000101941,
            -4.16909e-05,
            8.23584e-07,
            2.93073e-05,
            4.66033e-05,
            7.94438e-05,
            0.0263464,
            -0.0222734,
            -0.00129655,
            -0.000694156,
            -0.000324203,
            -0.000110489,
            2.02559e-06,
            5.20535e-05,
            6.59917e-05,
            6.32102e-05,
            0.0250288,
            -0.0228114,
            -0.00136195,
            -0.000659354,
            -0.00023752,
            -4.4988e-06,
            0.000107212,
            0.000145658,
            0.000143789,
            0.000450532,
            0.0105529,
            -0.0108415,
            -0.000660993,
            -0.000265295,
            -3.37213e-05,
            8.73116e-05,
            0.000137911,
            0.000147034,
            0.000134702,
            0.000582435,
            -0.00427491,
            0.00371227,
            0.000314585,
            0.000209294,
            0.000133316,
            7.89433e-05,
            4.08077e-05,
            1.51017e-05,
            -9.6856e-07,
            -1.7604e-06,
            -0.0111956,
            0.0124433,
            0.00104937,
            0.000554689,
            0.000236555,
            4.24886e-05,
            -6.71653e-05,
            -0.000121621,
            -0.000141802,
            -0.00107968,
            -0.00929305,
            0.0122729,
            0.00119751,
            0.000639043,
            0.000280619,
            6.35474e-05,
            -5.74253e-05,
            -0.000116185,
            -0.000137282,
            -0.00136653,
            -0.00260076,
            0.00538829,
            0.00066371,
            0.000363704,
            0.00017321,
            6.0433e-05,
            2.46207e-07,
            -2.65363e-05,
            -3.4017e-05,
            -0.000755169,
            -0.0337456,
            0.0236411,
            0.00147238,
            0.000945082,
            0.000582023,
            0.000346064,
            0.000204378,
            0.000129344,
            9.8701e-05,
            0.00137532,
            -0.0160634,
            0.0117294,
            0.000784102,
            0.000466069,
            0.000247336,
            0.000108234,
            2.98021e-05,
            -4.94052e-06,
            -1.03663e-05,
            0.000647743,
            0.00314271,
            -0.00238803,
            -0.000173765,
            -0.000124605,
            -8.80909e-05,
            -5.96323e-05,
            -3.64124e-05,
            -1.68492e-05,
            -1.67539e-07,
            0.000257222,
            0.0126329,
            -0.0103994,
            -0.000859341,
            -0.000507284,
            -0.000255186,
            -8.34246e-05,
            2.60999e-05,
            8.92068e-05,
            0.000119136,
            0.000497129,
            0.0110845,
            -0.0101102,
            -0.000975481,
            -0.000549298,
            -0.000239165,
            -2.60835e-05,
            0.000109349,
            0.000185322,
            0.000217898,
            0.00101066,
            0.0040493,
            -0.00449559,
            -0.000542305,
            -0.00028972,
            -0.00010157,
            3.00255e-05,
            0.000114628,
            0.000162119,
            0.00018182,
            0.00112951,
            -0.00203312,
            0.00171198,
            0.000175331,
            0.000132763,
            0.00010129,
            7.76109e-05,
            5.93797e-05,
            4.50073e-05,
            3.34797e-05,
            0.000407815,
            -0.00402473,
            0.00510545,
            0.00080382,
            0.000530902,
            0.000318952,
            0.000160586,
            4.72897e-05,
            -2.95326e-05,
            -7.79081e-05,
            -0.000822469,
            -0.00256032,
            0.00481047,
            0.00100775,
            0.000696884,
            0.000448938,
            0.000259278,
            0.000120598,
            2.44565e-05,
            -3.77052e-05,
            -0.00115562,
            2.16591e-05,
            0.00196335,
            0.000630205,
            0.000463212,
            0.000326846,
            0.000220829,
            0.000142606,
            8.83657e-05,
            5.37643e-05,
            0.000254889,
            0.00566335,
            -0.00391385,
            2.08008e-05,
            7.44478e-06,
            -3.47634e-05,
            -8.41897e-05,
            -0.0001282,
            -0.000160387,
            -0.000178494,
            -0.000463128,
            0.00275785,
            -0.00187614,
            9.67711e-05,
            7.12052e-05,
            2.50165e-05,
            -2.59776e-05,
            -7.21236e-05,
            -0.000108203,
            -0.000132086,
            -0.000310772,
            -0.000676155,
            0.000582073,
            5.41637e-05,
            3.41891e-05,
            1.66847e-05,
            1.70425e-06,
            -1.05556e-05,
            -1.99208e-05,
            -2.63251e-05,
            0.000159861,
            -0.00247535,
            0.00191954,
            -8.93162e-05,
            -9.52505e-05,
            -7.32557e-05,
            -3.89739e-05,
            -2.32199e-06,
            3.08685e-05,
            5.76025e-05,
            0.000781874,
            -0.00217234,
            0.00172137,
            -0.000214312,
            -0.000210099,
            -0.000166642,
            -0.000105292,
            -4.01347e-05,
            2.01095e-05,
            7.0599e-05,
            0.00123654,
            -0.00072513,
            0.000603004,
            -0.000201818,
            -0.000193807,
            -0.000158664,
            -0.000110349,
            -5.84481e-05,
            -9.19549e-06,
            3.36885e-05,
            0.00121413,
            0.000558393,
            -0.000483077,
            -3.52875e-05,
            -2.21112e-05,
            -1.16262e-05,
            -2.84247e-06,
            4.72943e-06,
            1.12853e-05,
            1.6869e-05,
            0.000658007,
            0.000955491,
            -0.00092187,
            0.000179723,
            0.000205034,
            0.000198464,
            0.000173593,
            0.00013989,
            0.000103706,
            6.90792e-05,
            -5.91602e-05,
            0.000563041,
            -0.000678396,
            0.000292815,
            0.000329218,
            0.000324086,
            0.000293907,
            0.000250564,
            0.000202343,
            0.000154769,
            -0.000211247,
            -7.87098e-05,
            -0.000107941,
            0.000221623,
            0.000249826,
            0.000252254,
            0.000238463,
            0.000215562,
            0.000188693,
            0.000161436,
            0.00104202,
            0.0331825,
            -0.0212997,
            -0.00108464,
            -0.000795111,
            -0.000597185,
            -0.000465708,
            -0.000381214,
            -0.000328855,
            -0.000297503,
            -0.00218417,
            0.0150806,
            -0.00966959,
            -0.000407911,
            -0.000265406,
            -0.000174892,
            -0.000122502,
            -9.71342e-05,
            -9.00324e-05,
            -9.4411e-05,
            -0.00129749,
            -0.0033487,
            0.00254575,
            0.000232513,
            0.000180058,
            0.000138635,
            0.000105028,
            7.70306e-05,
            5.31792e-05,
            3.254e-05,
            -0.00027239,
            -0.0113648,
            0.00832824,
            0.00050924,
            0.000317913,
            0.000186182,
            9.88325e-05,
            4.38886e-05,
            1.20303e-05,
            -3.90031e-06,
            0.000165768,
            -0.00887734,
            0.00706083,
            0.000421421,
            0.000208388,
            6.35816e-05,
            -2.91674e-05,
            -8.29927e-05,
            -0.000108455,
            -0.00011395,
            -4.349e-05,
            -0.00232473,
            0.00239855,
            0.000143967,
            2.45386e-05,
            -5.72647e-05,
            -0.000109364,
            -0.00013846,
            -0.000150165,
            -0.000149131,
            -0.000400149,
            0.00205588,
            -0.0015905,
            -0.000152525,
            -0.000122611,
            -0.000101015,
            -8.52239e-05,
            -7.33726e-05,
            -6.41115e-05,
            -5.64917e-05,
            -0.000301793,
            0.00225852,
            -0.00297083,
            -0.000367256,
            -0.00021908,
            -0.000110909,
            -3.42583e-05,
            1.78818e-05,
            5.12582e-05,
            7.05418e-05,
            0.00038325,
            0.000106702,
            -0.00209986,
            -0.000432319,
            -0.00026276,
            -0.000135094,
            -4.14408e-05,
            2.4911e-05,
            6.96399e-05,
            9.75145e-05,
            0.00094862,
            -0.00168056,
            -0.000321502,
            -0.000283808,
            -0.000192061,
            -0.000120749,
            -6.66019e-05,
            -2.67224e-05,
            1.44167e-06,
            2.01201e-05,
            0.000173555,
            0.0375089,
            -0.0225903,
            -0.00122204,
            -0.000991317,
            -0.000804635,
            -0.000654935,
            -0.000536053,
            -0.000442634,
            -0.000370061,
            -0.00267935,
            0.0167106,
            -0.00974886,
            -0.000429602,
            -0.00033605,
            -0.000260095,
            -0.000199686,
            -0.000152854,
            -0.000117734,
            -9.25835e-05,
            -0.00158598,
            -0.0036525,
            0.00268569,
            0.000264807,
            0.000215977,
            0.000177416,
            0.000146799,
            0.000122236,
            0.000102208,
            8.55073e-05,
            -0.00048329,
            -0.0119493,
            0.00783585,
            0.000540273,
            0.000410825,
            0.000305964,
            0.000221939,
            0.000155453,
            0.000103617,
            6.39154e-05,
            -0.000358197,
            -0.00886023,
            0.00603651,
            0.000443368,
            0.000315171,
            0.000208368,
            0.00012052,
            4.9364e-05,
            -7.18507e-06,
            -5.10416e-05,
            -0.00111023,
            -0.00196947,
            0.00163998,
            0.000170362,
            0.000106238,
            4.96239e-05,
            2.56815e-07,
            -4.21948e-05,
            -7.81144e-05,
            -0.000107922,
            -0.0017832,
            0.00203857,
            -0.00141,
            -0.000125113,
            -0.000105913,
            -9.22851e-05,
            -8.32193e-05,
            -7.78348e-05,
            -7.5367e-05,
            -7.5156e-05,
            -0.00143376,
            0.00156283,
            -0.00189512,
            -0.00036371,
            -0.000290321,
            -0.00022685,
            -0.00017237,
            -0.000126007,
            -8.6942e-05,
            -5.44104e-05,
            -5.55991e-05,
            -0.000905461,
            -0.000824968,
            -0.000472726,
            -0.000401912,
            -0.000337098,
            -0.000278046,
            -0.000224494,
            -0.000176164,
            -0.000132765,
            0.00108314,
            -0.0023734,
            0.000363931,
            -0.000362099,
            -0.000337404,
            -0.000313179,
            -0.000289599,
            -0.000266806,
            -0.000244908,
            -0.000223989,
            -0.00128516,
            0.0207492,
            -0.0116148,
            -0.000541875,
            -0.000500877,
            -0.000461337,
            -0.000423422,
            -0.000387258,
            -0.000352934,
            -0.000320506,
            -0.00180699,
            0.00919568,
            -0.00474765,
            -0.000110569,
            -0.000119548,
            -0.000125749,
            -0.000129549,
            -0.000131289,
            -0.000131274,
            -0.000129782,
            -0.00110536,
            -0.00188571,
            0.00137001,
            0.000155911,
            0.000132051,
            0.000110572,
            9.13119e-05,
            7.4114e-05,
            5.88277e-05,
            4.53087e-05,
            -0.000116094,
            -0.00630702,
            0.0035072,
            0.000157169,
            0.000146292,
            0.000135624,
            0.000125225,
            0.000115146,
            0.000105426,
            9.60965e-05,
            0.000472654,
            -0.00464977,
            0.00234721,
            2.68547e-05,
            3.16175e-05,
            3.54398e-05,
            3.84226e-05,
            4.06588e-05,
            4.22336e-05,
            4.32249e-05,
            0.000450674,
            -0.00107013,
            0.000370133,
            -6.32679e-05,
            -5.51928e-05,
            -4.77527e-05,
            -4.09119e-05,
            -3.46362e-05,
            -2.88924e-05,
            -2.3649e-05,
            7.13435e-05,
            0.00094143,
            -0.000581626,
            -5.14834e-05,
            -4.9211e-05,
            -4.69204e-05,
            -4.46246e-05,
            -4.23349e-05,
            -4.00614e-05,
            -3.78129e-05,
            -0.000240972,
            0.000660447,
            -0.000304007,
            7.33086e-06,
            5.01726e-06,
            2.9119e-06,
            9.99957e-07,
            -7.32415e-07,
            -2.29819e-06,
            -3.70949e-06,
            -0.000197095,
            -0.000553952,
            0.000348791,
            3.2606e-05,
            3.10158e-05,
            2.95031e-05,
            2.80642e-05,
            2.66955e-05,
            2.53936e-05,
            2.41551e-05,
            0.00024145,
            -0.00120285,
            0.000600676,
            2.15276e-16,
            -3.49993e-16,
            5.04321e-17,
            1.01205e-16,
            1.09669e-16,
            7.78521e-17,
            -7.14194e-17,
            -4.16334e-17,
    };
}

template <class T> void
autoreg::cholesky(T* A, T* b, uint32_t N) {
    std::copy_n(coefs, N, b);
    /*
    Index<2> idx(size2(N, N));
    std::valarray<T> L(N*N);
    L =0;
    const int n = N;
    // A=L*T (T - transposed L)
    for (int i=0; i<n; ++i) {
        for (int j=0; j<i; ++j) {
            T sum = 0;
            for (int k=0; k<j+1; ++k) {
                sum += L[idx(i,k)]*L[idx(j,k)];
            }
            L[idx(i,j)] = (A[idx(i,j)] - sum) / L[idx(j,j)];
        }
        T sum = 0;
        for (int j=0; j<i+1; ++j) {
            auto l = L[idx(i,j)];
            sum += l*l;
        }
        T s = A[idx(i,i)] - sum;
        if (s <= 0) {
            std::clog << "L[idx(i,i)]=" << L[idx(i,i)] << std::endl;
            std::clog << "i=" << i << std::endl;
            std::clog << "s=" << s << std::endl;
            std::clog << "sum=" << sum << std::endl;
            throw std::runtime_error("not positive definite");
        }
        L[idx(i,i)] = std::sqrt(s);
    }
    // solve L*y=b
    T* y = b;
    for (int i=0; i<n; i++) {
        T sum = 0;
        for (int j=0; j<i; j++) {
            sum += A[idx(i,j)]*y[j];
        }
        y[i] = (b[i] - sum)/A[idx(i,i)];
    }
    // solve T*b=y
    for (int i=n-1; i>=0; i--) {
        T sum = 0;
        for (int j=i+1; j<n; j++) {
            sum += A[idx(j,i)]*b[j];
        }
        b[i] = (y[i] - sum)/A[idx(i,i)];
    }
    */
}

template void
autoreg::cholesky(AUTOREG_REAL_TYPE* A, AUTOREG_REAL_TYPE* b, uint32_t N);
